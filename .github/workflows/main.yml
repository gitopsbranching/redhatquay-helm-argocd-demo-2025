name: Build, Push to Quay, and Update Helm Chart

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-update:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set image tag based on commit SHA
      - name: Set IMAGE_TAG
        run: echo "IMAGE_TAG=nodeapp-${GITHUB_SHA::7}" >> $GITHUB_ENV

      # 3. Log in to Red Hat Quay
      - name: Log in to Quay
        uses: docker/login-action@v2
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      # 4. Build and push Docker image to Quay
      - name: Build and Push Docker image
        run: |
          docker build -t quay.io/${{ secrets.QUAY_USERNAME }}/node-app:${{ env.IMAGE_TAG }} .
          docker push quay.io/${{ secrets.QUAY_USERNAME }}/node-app:${{ env.IMAGE_TAG }}

      # 5. Update Helm values.yaml with the new image tag
      - name: Update image tag in values.yaml
        run: |
          sed -i "s|tag:.*|tag: \"${IMAGE_TAG}\"|" node-app/values.yaml

      # 6. Create Pull Request with updated values.yaml
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GH_TOKEN }}
          commit-message: "Update image tag to ${{ env.IMAGE_TAG }}"
          branch: update-image-tag   # ✅ fixed branch name
          base: main
          title: "Update Helm image tag"
          body: |
            This PR updates the Helm chart values.yaml with the new image tag `${{ env.IMAGE_TAG }}`.
          labels: automated-pr
          delete-branch: true   # ✅ cleans up after merge
